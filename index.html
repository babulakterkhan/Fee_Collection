<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤ ‡¶´‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü - SMS ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡¶π</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .school-header { 
            text-align: center; 
            margin-bottom: 25px; 
            border-bottom: 2px solid #1a73e8; 
            padding-bottom: 15px; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            gap: 10px; 
        }
        #schoolLogoImg { max-width: 80px; max-height: 80px; display: none; border-radius: 5px; flex-shrink: 0; }
        .school-info { flex-grow: 1; }
        #headerName { margin: 0; color: #1a73e8; font-size: clamp(20px, 5vw, 30px); white-space: nowrap; }
        #headerAddress { margin: 5px 0 0; font-size: 14px; }

        .settings-panel { display: none; background: #fffde7; border: 1px dashed #fbc02d; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-box, .search-panel { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .search-panel { background: #f1f8e9; border: 1px solid #dcedc8; grid-template-columns: repeat(5, 1fr); }
        .full-row { grid-column: span 4; }
        
        .year-month-box { background: #fff; padding: 15px; border: 1px solid #bbdefb; border-radius: 8px; margin-top: 10px; }
        .month-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 10px; }
        .month-item { font-size: 13px; display: flex; align-items: center; gap: 5px; cursor: pointer; background: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
        
        .fee-selection { grid-column: span 4; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #1a73e8; color: white; }
        .total-row { background-color: #263238; color: #ffeb3b; font-weight: bold; }

        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-save { background: #2e7d32; width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #studentNameDisplay { font-weight: bold; color: #1565c0; background: #fff; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; min-height: 20px; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="school-header">
        <img id="schoolLogoImg" src="" alt="Logo">
        <div class="school-info">
            <h1 id="headerName">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</h1>
            <p id="headerAddress">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p>
        </div>
        <div style="position: absolute; right: 30px; top: 30px;" class="no-print">
            <button onclick="openSettings()" style="background:#546e7a; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
        </div>
    </div>

    <div id="settingsArea" class="settings-panel no-print">
        <h3>üõ† ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì SMS ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="text" id="setSchoolName" placeholder="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="text" id="setSchoolAddr" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ">
            <input type="text" id="setSchoolMob" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤)">
            <input type="text" id="setSmsApiKey" placeholder="https://api.bdbulksms.net/api.php">
            <input type="text" id="setNewPass" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
            <div><label style="font-size:11px;">‡¶≤‡ßã‡¶ó‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶°:</label><input type="file" id="logoUpload" accept="image/*" onchange="previewLogo(this)"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="exportData()" class="btn" style="background:#1565c0;">üíæ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶®</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(this)" style="width: auto;">
        </div>
        <button onclick="saveSettings()" class="btn" style="background:#2e7d32; margin-top:10px;">‡¶∏‡¶¨ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="document.getElementById('settingsArea').style.display='none'" class="btn" style="background:#757575; margin-top:10px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div class="input-box no-print">
        <div><label>‡¶∞‡ßã‡¶≤:</label><input type="number" id="rollInput" oninput="findStudent()"></div>
        <div><label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø:</label><select id="classSelect" onchange="findStudent()"><option value="One">One</option><option value="Two">Two</option><option value="Three">Three</option><option value="Four">Four</option><option value="Five">Five</option><option value="Six">Six</option><option value="Seven">Seven</option><option value="Eight">Eight</option><option value="Nine">Nine</option><option value="Ten">Ten</option><option value="Eleven">Eleven</option><option value="Twelve">Twelve</option></select></div>
        <div><label>‡¶∂‡¶æ‡¶ñ‡¶æ:</label><select id="sectionSelect"><option value="A">A</option><option value="B">B</option><option value="N/A">N/A</option></select></div>
        <div><label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label><select id="groupSelect"><option value="General">General</option><option value="Science">Science</option><option value="Commerce">Commerce</option><option value="Humanities">Humanities</option></select></div>
        <div style="grid-column: span 2;"><label>‡¶®‡¶æ‡¶Æ:</label><div id="studentNameDisplay">‡¶∞‡ßã‡¶≤ ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶¶‡¶ø‡¶®...</div></div>
        <div><label>‡¶∏‡ßá‡¶∂‡¶®:</label><input type="text" id="sessionInput" placeholder="‡ß®‡ß¶‡ß®‡ß¨"></div>
        <div><label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="entryDate"></div>
        
        <div class="full-row year-month-box">
            <input type="number" id="targetYear" style="width: 100px;" value="2026">
            <button onclick="addSelectedMonths()" class="btn" style="background: #1a73e8; font-size: 12px;">+ ‡¶Æ‡¶æ‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <span id="addedMonthsDisplay" style="font-weight:bold; margin-left:10px; color:red;">‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡¶æ</span>
            <div class="month-grid">
                <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡¶æ‡¶®‡ßÅ"> ‡¶ú‡¶æ‡¶®‡ßÅ</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ"> ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö"> ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤"> ‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Æ‡ßá"> ‡¶Æ‡ßá</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡ßÅ‡¶®"> ‡¶ú‡ßÅ‡¶®</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á"> ‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü"> ‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá"> ‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Ö‡¶ï‡ßç‡¶ü‡ßã"> ‡¶Ö‡¶ï‡ßç‡¶ü‡ßã</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶®‡¶≠‡ßá"> ‡¶®‡¶≠‡ßá</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶°‡¶ø‡¶∏‡ßá"> ‡¶°‡¶ø‡¶∏‡ßá</label>
            </div>
        </div>

        <div class="fee-selection">
            <div>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø<input type="number" id="valM" placeholder="0"><input type="checkbox" id="checkM"></div>
            <div>‡¶∏‡ßá‡¶∂‡¶® ‡¶´‡¶ø<input type="number" id="valS" placeholder="0"><input type="checkbox" id="checkS"></div>
            <div>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø<input type="number" id="valE" placeholder="0"><input type="checkbox" id="checkE"></div>
            <div>‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø<input type="number" id="valO" placeholder="0"><input type="checkbox" id="checkO"></div>
            <div>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ<input type="number" id="valDue" style="color:red" placeholder="0"></div>
        </div>
        <div class="full-row"><button onclick="saveData()" class="btn btn-save">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì SMS ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button></div>
    </div>

    <div class="search-panel no-print">
        <div style="grid-column: span 2;"><label>üîç ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®:</label><input type="text" id="searchIndi" placeholder="‡¶®‡¶æ‡¶Æ/‡¶∞‡ßã‡¶≤..." onkeyup="updateTable()"></div>
        <div><label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø:</label><select id="searchCls" onchange="updateTable()"><option value="">‡¶∏‡¶¨ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</option><option value="One">One</option><option value="Two">Two</option><option value="Three">Three</option><option value="Four">Four</option><option value="Five">Five</option><option value="Six">Six</option><option value="Seven">Seven</option><option value="Eight">Eight</option><option value="Nine">Nine</option><option value="Ten">Ten</option><option value="Eleven">Eleven</option><option value="Twelve">Twelve</option></select></div>
        <div><label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label><select id="searchGroup" onchange="updateTable()"><option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</option><option value="General">General</option><option value="Science">Science</option><option value="Commerce">Commerce</option><option value="Humanities">Humanities</option></select></div>
        <div><label>‡¶∏‡ßá‡¶∂‡¶®:</label><input type="text" id="searchSes" placeholder="‡ß®‡ß¶‡ß®‡ß¨" onkeyup="updateTable()"></div>
        <div><label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="searchSDate" onchange="updateTable()"></div>
        <div><label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="searchEDate" onchange="updateTable()"></div>
        <div style="grid-column: span 3; display: flex; align-items: flex-end;">
            <button onclick="printFullReport()" class="btn" style="background:#5c6bc0; width: 100%; height: 40px; font-size: 15px;">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞)</button>
        </div>
    </div>

    <table id="feeTable">
        <thead>
            <tr>
                <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                <th>‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶∞‡ßã‡¶≤</th>
                <th>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</th>
                <th>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</th> <th>‡¶Æ‡¶æ‡¶∏</th>
                <th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                <th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</th>
                <th>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</th>
                <th class="no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="6">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü:</td>
                <td id="grandTotal">0</td>
                <td id="grandDue">0</td>
                <td class="no-print"></td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
    const DB_NAME = 'universalDB_v12';
    let finalMonthsList = [];
    let tempLogoBase64 = "";

    // ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ (‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶π)
    const students = [
        { roll: 101, class: "One", name: "‡¶∞‡¶π‡¶ø‡¶Æ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", mobile: "01715082325" },
        { roll: 102, class: "One", name: "‡¶∏‡¶æ‡¶¨‡ßç‡¶¨‡¶ø‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®", mobile: "01800000000" },
        { roll: 101, class: "Ten", name: "‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡¶æ‡¶π", mobile: "01900000000" }
    ];

    window.onload = function() {
        let config = JSON.parse(localStorage.getItem('appConfig'));
        if (!config) {
            config = { name: "‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ", addr: "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ", mob: "017...", pass: "1234", logo: "", smsKey: "" };
            localStorage.setItem('appConfig', JSON.stringify(config));
        }
        loadSettings();
        updateTable();
    };

    function loadSettings() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        document.getElementById('headerName').innerText = config.name;
        document.getElementById('headerAddress').innerText = config.addr + " | " + config.mob;
        document.getElementById('setSchoolName').value = config.name;
        document.getElementById('setSchoolAddr').value = config.addr;
        document.getElementById('setSchoolMob').value = config.mob;
        document.getElementById('setSmsApiKey').value = config.smsKey || "";
        
        if(config.logo) {
            document.getElementById('schoolLogoImg').src = config.logo;
            document.getElementById('schoolLogoImg').style.display = "block";
            tempLogoBase64 = config.logo;
        }
    }

    function previewLogo(input) {
        if (input.files && input.files[0]) {
            let reader = new FileReader();
            reader.onload = (e) => { tempLogoBase64 = e.target.result; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function openSettings() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        if(prompt("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:") === config.pass) document.getElementById('settingsArea').style.display = "block";
        else alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°!");
    }

    function saveSettings() {
        const current = JSON.parse(localStorage.getItem('appConfig'));
        const config = {
            name: document.getElementById('setSchoolName').value,
            addr: document.getElementById('setSchoolAddr').value,
            mob: document.getElementById('setSchoolMob').value,
            smsKey: document.getElementById('setSmsApiKey').value,
            pass: document.getElementById('setNewPass').value || current.pass,
            logo: tempLogoBase64
        };
        localStorage.setItem('appConfig', JSON.stringify(config));
        location.reload();
    }

    function findStudent() {
        const roll = document.getElementById('rollInput').value;
        const sClass = document.getElementById('classSelect').value;
        const student = students.find(s => s.roll == roll && s.class == sClass);
        document.getElementById('studentNameDisplay').innerText = student ? student.name + " (‡¶∞‡ßã‡¶≤: " + student.roll + ")" : "‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!";
    }

    function addSelectedMonths() {
        let year = document.getElementById('targetYear').value;
        document.querySelectorAll('input[name="months"]:checked').forEach(cb => {
            let entry = cb.value + "-" + year;
            if(!finalMonthsList.includes(entry)) finalMonthsList.push(entry);
            cb.checked = false;
        });
        document.getElementById('addedMonthsDisplay').innerText = finalMonthsList.join(", ");
    }

    // SMS ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (GreenWeb API)
    async function sendSMS(studentName, amount, mobile) {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        if(!config.smsKey || !mobile) return;

        const message = `‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ${studentName}-‡¶è‡¶∞ ‡¶´‡¶ø ‡¶¨‡¶æ‡¶¨‡¶¶ ${amount} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§ - ${config.name}`;
        const url = `https://api.greenweb.com.bd/api.php?json&apikey=${config.smsKey}&to=${mobile}&message=${encodeURIComponent(message)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            console.log("SMS Status:", data);
        } catch (err) {
            console.error("SMS Failed:", err);
        }
    }

    function saveData() {
        let paid = 0;
        let detailsArr = [];
        
        if(document.getElementById('checkM').checked) {
            let val = parseFloat(document.getElementById('valM').value)||0;
            paid += val; detailsArr.push("‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï:" + val);
        }
        if(document.getElementById('checkS').checked) {
            let val = parseFloat(document.getElementById('valS').value)||0;
            paid += val; detailsArr.push("‡¶∏‡ßá‡¶∂‡¶®:" + val);
        }
        if(document.getElementById('checkE').checked) {
            let val = parseFloat(document.getElementById('valE').value)||0;
            paid += val; detailsArr.push("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ:" + val);
        }
        if(document.getElementById('checkO').checked) {
            let val = parseFloat(document.getElementById('valO').value)||0;
            paid += val; detailsArr.push("‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø:" + val);
        }

        if(paid === 0 && !confirm("‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) return;

        const roll = document.getElementById('rollInput').value;
        const sClass = document.getElementById('classSelect').value;
        const studentObj = students.find(s => s.roll == roll && s.class == sClass);

        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let newEntry = {
            id: Date.now(),
            date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
            session: document.getElementById('sessionInput').value,
            student: document.getElementById('studentNameDisplay').innerText,
            class: document.getElementById('classSelect').value,
            section: document.getElementById('sectionSelect').value,
            group: document.getElementById('groupSelect').value,
            months: finalMonthsList.join(", "),
            paid, 
            due: parseFloat(document.getElementById('valDue').value) || 0,
            details: detailsArr.length > 0 ? detailsArr.join(", ") : "‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£"
        };

        history.push(newEntry);
        localStorage.setItem(DB_NAME, JSON.stringify(history));

        // SMS ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞
        if(studentObj && studentObj.mobile && paid > 0) {
            sendSMS(studentObj.name, paid, studentObj.mobile);
        }

        alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        location.reload();
    }

    function updateTable() {
        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let kIndi = document.getElementById('searchIndi').value.toUpperCase();
        let kCls = document.getElementById('searchCls').value;
        let kGrp = document.getElementById('searchGroup').value;
        let kSes = document.getElementById('searchSes').value;
        let sDate = document.getElementById('searchSDate').value, eDate = document.getElementById('searchEDate').value;

        let tableBody = document.getElementById('tableBody');
        let tPaid = 0, tDue = 0; tableBody.innerHTML = "";

        history.slice().reverse().forEach(item => {
            const matchesSearch = item.student.toUpperCase().includes(kIndi);
            const matchesClass = !kCls || item.class === kCls;
            const matchesGroup = !kGrp || item.group === kGrp;
            const matchesSession = !kSes || (item.session && item.session.includes(kSes));
            const matchesDate = (!sDate || !eDate) || (item.date >= sDate && item.date <= eDate);

            if(matchesSearch && matchesClass && matchesGroup && matchesSession && matchesDate) {
                tPaid += item.paid; tDue += item.due;
                tableBody.innerHTML += `<tr>
                    <td>${item.date}</td>
                    <td>${item.student}</td>
                    <td>${item.class}</td>
                    <td>${item.group}</td> <td>${item.months}</td>
                    <td>${item.details}</td>
                    <td>${item.paid}</td>
                    <td>${item.due}</td>
                    <td class="no-print">
                        <button onclick="printReceipt(${item.id})" style="background:#0288d1; color:white; border:none; padding:3px 8px; cursor:pointer;">‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü</button> 
                        <button onclick="deleteItem(${item.id})" style="background:red; color:white; border:none; padding:3px 8px; cursor:pointer;">X</button>
                    </td>
                </tr>`;
            }
        });
        document.getElementById('grandTotal').innerText = tPaid;
        document.getElementById('grandDue').innerText = tDue;
    }

    function printReceipt(id) {
        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let item = history.find(i => i.id === id);
        let config = JSON.parse(localStorage.getItem('appConfig'));
        
        let win = window.open('', '', 'height=750,width=850');
        win.document.write(`
            <html>
            <head>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
                    body { font-family: 'Hind Siliguri', sans-serif; padding: 20px; display: flex; justify-content: center; }
                    .receipt-border { border: 6px double #1a73e8; padding: 30px; width: 620px; background: #fff; box-sizing: border-box; }
                    .h-box { text-align: center; border-bottom: 2px solid #1a73e8; padding-bottom: 12px; margin-bottom: 18px; }
                    .h-box img { width: 75px; height: 75px; margin-bottom: 8px; }
                    .h-box h1 { margin: 0; color: #1a73e8; font-size: 34px; font-weight: 700; }
                    .h-box p { margin: 4px 0; font-size: 16px; color: #333; font-weight: 600; }
                    .title-tag { text-align: center; background: #1a73e8 !important; color: white !important; padding: 10px; font-weight: bold; margin-bottom: 20px; border-radius: 6px; font-size: 22px; -webkit-print-color-adjust: exact; }
                    .info-row { display: flex; justify-content: space-between; border-bottom: 1.5px dotted #999; padding: 12px 0; font-size: 19px; color: #000; }
                    .info-row b { color: #1a73e8; }
                    .details-box { margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; min-height: 50px; font-size: 18px; background: #fafafa; color: #333; line-height: 1.5; }
                    .amount-section { background: #f0f7ff !important; padding: 20px; border: 2.5px solid #1a73e8; display: flex; justify-content: space-between; -webkit-print-color-adjust: exact; margin-top: 25px; border-radius: 8px; font-size: 24px; }
                    .footer { margin-top: 70px; display: flex; justify-content: space-between; }
                    .sig { width: 190px; border-top: 2px solid #333; text-align: center; font-size: 16px; padding-top: 10px; font-weight: 700; }
                </style>
            </head>
            <body>
                <div class="receipt-border">
                    <div class="h-box">
                        ${config.logo ? `<img src="${config.logo}">` : ''}
                        <h1>${config.name}</h1>
                        <p>${config.addr} | ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${config.mob}</p>
                    </div>
                    <div class="title-tag">‡¶Æ‡¶æ‡¶®‡¶ø ‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü (‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶ï‡¶™‡¶ø)</div>
                    <div class="info-row"><span>‡¶®‡¶æ‡¶Æ: <b>${item.student}</b></span><span>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <b>${item.date}</b></span></div>
                    <div class="info-row"><span>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø: <b>${item.class}</b> | ‡¶∂‡¶æ‡¶ñ‡¶æ: <b>${item.section}</b></span><span>ID: #${item.id.toString().slice(-6)}</span></div>
                    <div class="info-row"><span>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó: <b>${item.group}</b> | ‡¶∏‡ßá‡¶∂‡¶®: <b>${item.session || 'N/A'}</b></span></div>
                    <div class="info-row"><span>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶∏: <b>${item.months}</b></span></div>
                    <div style="margin-top:15px; font-weight:bold; font-size:18px; color:#555;">‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</div>
                    <div class="details-box">${item.details}</div>
                    <div class="amount-section">
                        <b>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º: ‡ß≥ ${item.paid}/-</b>
                        <b style="color:#d32f2f">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥ ${item.due}/-</b>
                    </div>
                    <div class="footer">
                        <div class="sig">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï/‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
                        <div class="sig">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
                    </div>
                </div>
            </body>
            </html>
        `);
        win.document.close();
        setTimeout(() => { win.print(); win.close(); }, 500);
    }

    function printFullReport() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        const tableClone = document.getElementById('feeTable').cloneNode(true);
        tableClone.querySelectorAll('.no-print').forEach(el => el.remove());
        const sDate = document.getElementById('searchSDate').value;
        const eDate = document.getElementById('searchEDate').value;

        let win = window.open('', '', 'height=800,width=1200');
        win.document.write(`
            <html>
            <head>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
                    body { font-family: 'Hind Siliguri', sans-serif; padding: 30px; }
                    .report-header { display: flex; flex-direction: column; align-items: center; text-align: center; border-bottom: 3px solid #1a73e8; padding-bottom: 15px; margin-bottom: 20px; }
                    .report-header img { width: 80px; height: 80px; margin-bottom: 10px; }
                    .report-header h1 { margin: 0; color: #1a73e8; font-size: 30px; }
                    .report-header p { margin: 5px 0; color: #555; }
                    .report-title { text-align: center; color: #d32f2f; font-size: 22px; margin: 10px 0; font-weight: bold; text-decoration: underline; }
                    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                    th { background-color: #1a73e8 !important; color: white !important; -webkit-print-color-adjust: exact; }
                    .total-row { background-color: #eee !important; color: #1a73e8 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
                    .footer-sig { margin-top: 80px; display: flex; justify-content: space-between; }
                    .sig-box { border-top: 2px solid #000; width: 200px; text-align: center; padding-top: 5px; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="report-header">
                    ${config.logo ? `<img src="${config.logo}">` : ''}
                    <h1>${config.name}</h1>
                    <p>${config.addr} | ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${config.mob}</p>
                </div>
                <div class="report-title">‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</div>
                <p style="text-align:center;"><b>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</b> ${sDate ? sDate + ' ‡¶π‡¶§‡ßá ' + eDate : '‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ'}</p>
                <table>${tableClone.innerHTML}</table>
                <div class="footer-sig"><div class="sig-box">‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡¶∞‡¶ï‡ßç‡¶∑‡¶ï</div><div class="sig-box">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶®</div></div>
            </body>
            </html>
        `);
        win.document.close();
        setTimeout(() => { win.print(); win.close(); }, 500);
    }

    function exportData() {
        const data = { config: JSON.parse(localStorage.getItem('appConfig')), history: JSON.parse(localStorage.getItem(DB_NAME)) };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'School_Backup.json'; a.click();
    }

    function deleteItem(id) {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            let h = JSON.parse(localStorage.getItem(DB_NAME));
            localStorage.setItem(DB_NAME, JSON.stringify(h.filter(i => i.id !== id)));
            updateTable();
        }
    }
</script>
</body>
</html>