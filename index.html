<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü - ‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶ì ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ñ‡¶æ‡¶§‡¶æ</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .school-header { 
            text-align: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #1a73e8; 
            padding-bottom: 15px; 
            position: relative;
        }
        #schoolLogoImg { max-width: 80px; max-height: 80px; display: none; border-radius: 5px; margin-bottom: 10px; }
        #headerName { margin: 0; color: #1a73e8; font-size: clamp(20px, 5vw, 30px); }
        #headerAddress { margin: 5px 0 0; font-size: 14px; }

        /* Tab Styles */
        .tab-container { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: bold; color: #555; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: #1a73e8; border-bottom: 3px solid #1a73e8; }
        .tab-btn:hover { background: #f0f2f5; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .settings-panel { display: none; background: #fffde7; border: 1px dashed #fbc02d; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-box, .search-panel { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .search-panel { background: #f1f8e9; border: 1px solid #dcedc8; grid-template-columns: repeat(5, 1fr); }
        .full-row { grid-column: span 4; }
        
        .year-month-box { background: #fff; padding: 15px; border: 1px solid #bbdefb; border-radius: 8px; margin-top: 10px; }
        .month-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 10px; }
        .month-item { font-size: 13px; display: flex; align-items: center; gap: 5px; cursor: pointer; background: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
        
        .fee-selection { grid-column: span 4; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #1a73e8; color: white; }
        .total-row { background-color: #263238; color: #ffeb3b; font-weight: bold; }

        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-save { background: #2e7d32; width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #studentNameDisplay { font-weight: bold; color: #1565c0; background: #fff; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; min-height: 20px; }

        .student-list-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .student-list-table th, .student-list-table td { border: 1px solid #ccc; padding: 5px; text-align: left; }
        .student-list-container { max-height: 250px; overflow-y: auto; border: 1px solid #eee; margin-top: 10px; }
        .edit-mode { border: 2px solid #ff9800 !important; background: #fff3e0; }

        /* Income/Expense Specific Styles */
        .ie-form { background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; align-items: end; }
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .card { padding: 20px; border-radius: 8px; text-align: center; color: white; }
        .card-income { background: #2e7d32; }
        .card-expense { background: #c62828; }
        .card-balance { background: #1565c0; }
        .card h2 { margin: 0; font-size: 28px; }
        .card p { margin: 5px 0 0; opacity: 0.9; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="school-header">
        <div style="position: absolute; right: 20px; top: 20px;" class="no-print">
            <button onclick="openSettings()" style="background:#546e7a; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
        </div>
        <img id="schoolLogoImg" src="" alt="Logo">
        <h1 id="headerName">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</h1>
        <p id="headerAddress">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p>
    </div>

    <!-- TAB NAVIGATION -->
    <div class="tab-container no-print">
        <button class="tab-btn active" onclick="switchTab('feeTab')">üí∞ ‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü ‡¶ì ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</button>
        <button class="tab-btn" onclick="switchTab('accountsTab')">üìä ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ñ‡¶æ‡¶§‡¶æ (‡¶Ü‡ßü-‡¶¨‡ßç‡¶Ø‡ßü)</button>
    </div>

    <!-- SETTINGS PANEL (Global) -->
    <div id="settingsArea" class="settings-panel no-print">
        <h3>üõ† ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì ‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
            <input type="text" id="setSchoolName" placeholder="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="text" id="setSchoolAddr" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ">
            <input type="text" id="setSchoolMob" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
            <input type="text" id="setNewPass" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
            <div><label style="font-size:11px;">‡¶≤‡ßã‡¶ó‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶°:</label><input type="file" id="logoUpload" accept="image/*" onchange="previewLogo(this)"></div>
        </div>

        <hr style="border:1px dashed #ddd;">
        
        <h3 style="color:#d32f2f;">üë®‚Äçüéì ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
        <div style="background:#fff; padding:15px; border:1px solid #ddd; border-radius:5px;">
            <div id="studentFormBox" style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                <h4 style="margin:0 0 10px; font-size:14px;">‡¶è‡¶ï‡¶ï ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶Ø‡ßã‡¶ó/‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</h4>
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; margin-bottom:5px;">
                    <input type="text" id="newStName" placeholder="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                    <input type="text" id="newStClass" placeholder="‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø">
                    <input type="number" id="newStRoll" placeholder="‡¶∞‡ßã‡¶≤">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px;">
                    <input type="text" id="newStSection" placeholder="‡¶∂‡¶æ‡¶ñ‡¶æ">
                    <input type="text" id="newStGroup" placeholder="‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó">
                    <input type="text" id="newStSession" placeholder="‡¶∏‡ßá‡¶∂‡¶®">
                    <button id="addStudentBtn" onclick="saveStudentData()" class="btn" style="background:#ff9800;">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
             <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; align-items: end;">
                <div>
                    <label style="font-size:11px; color:#666;">CSV: Name, Class, Roll, Section, Group, Session</label>
                    <input type="file" id="csvStudentFile" accept=".csv">
                </div>
                <button onclick="uploadStudentCSV()" class="btn" style="background:#009688;">CSV ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</button>
            </div>
            <div class="student-list-container">
                <table class="student-list-table">
                    <thead><tr><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</th><th>‡¶∞‡ßã‡¶≤</th><th>‡¶∂‡¶æ‡¶ñ‡¶æ</th><th>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</th><th>‡¶∏‡ßá‡¶∂‡¶®</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
                    <tbody id="studentListPreviewBody"></tbody>
                </table>
            </div>
        </div>

        <hr style="border:1px dashed #ddd; margin-top:15px;">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="exportData()" class="btn" style="background:#1565c0;">üíæ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</button>
            <input type="file" id="importFile" accept=".json" onchange="importData(this)" style="width: auto;">
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="saveSettings()" class="btn" style="background:#2e7d32; flex:1;">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button onclick="document.getElementById('settingsArea').style.display='none'" class="btn" style="background:#757575; flex:1;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- TAB 1: FEE COLLECTION -->
    <div id="feeTab" class="tab-content active">
        <div class="input-box no-print">
            <div><label>‡¶∞‡ßã‡¶≤:</label><input type="number" id="rollInput" oninput="findStudent()"></div>
            <div><label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø:</label><select id="classSelect" onchange="findStudent()"><option value="One">One</option><option value="Two">Two</option><option value="Three">Three</option><option value="Four">Four</option><option value="Five">Five</option><option value="Six">Six</option><option value="Seven">Seven</option><option value="Eight">Eight</option><option value="Nine">Nine</option><option value="Ten">Ten</option><option value="Eleven">Eleven</option><option value="Twelve">Twelve</option></select></div>
            <div><label>‡¶∂‡¶æ‡¶ñ‡¶æ:</label><select id="sectionSelect"><option value="A">A</option><option value="B">B</option><option value="N/A">N/A</option></select></div>
            <div><label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label><select id="groupSelect"><option value="General">General</option><option value="Science">Science</option><option value="Commerce">Commerce</option><option value="Humanities">Humanities</option></select></div>
            
            <div style="grid-column: span 2;"><label>‡¶®‡¶æ‡¶Æ:</label><div id="studentNameDisplay">‡¶∞‡ßã‡¶≤ ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶¶‡¶ø‡¶®...</div></div>
            <div><label>‡¶∏‡ßá‡¶∂‡¶®:</label><input type="text" id="sessionInput" placeholder="‡ß®‡ß¶‡ß®‡ß™-‡ß®‡ß´"></div>
            <div><label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="entryDate"></div>
            
            <div class="full-row year-month-box">
                <input type="number" id="targetYear" style="width: 100px;" value="2026">
                <button onclick="addSelectedMonths()" class="btn" style="background: #1a73e8; font-size: 12px;">+ ‡¶Æ‡¶æ‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <span id="addedMonthsDisplay" style="font-weight:bold; margin-left:10px; color:red;">‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡¶æ</span>
                <div class="month-grid">
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡¶æ‡¶®‡ßÅ"> ‡¶ú‡¶æ‡¶®‡ßÅ</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ"> ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö"> ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤"> ‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶Æ‡ßá"> ‡¶Æ‡ßá</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡ßÅ‡¶®"> ‡¶ú‡ßÅ‡¶®</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á"> ‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü"> ‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá"> ‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶Ö‡¶ï‡ßç‡¶ü‡ßã"> ‡¶Ö‡¶ï‡ßç‡¶ü‡ßã</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶®‡¶≠‡ßá"> ‡¶®‡¶≠‡ßá</label>
                    <label class="month-item"><input type="checkbox" name="months" value="‡¶°‡¶ø‡¶∏‡ßá"> ‡¶°‡¶ø‡¶∏‡ßá</label>
                </div>
            </div>

            <div class="fee-selection">
                <div>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø<input type="number" id="valM" placeholder="0"><input type="checkbox" id="checkM"></div>
                <div>‡¶∏‡ßá‡¶∂‡¶® ‡¶´‡¶ø<input type="number" id="valS" placeholder="0"><input type="checkbox" id="checkS"></div>
                <div>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø<input type="number" id="valE" placeholder="0"><input type="checkbox" id="checkE"></div>
                <div>‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø<input type="number" id="valO" placeholder="0"><input type="checkbox" id="checkO"></div>
                <div>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ<input type="number" id="valDue" style="color:red" placeholder="0"></div>
            </div>
            <div class="full-row"><button id="saveBtn" onclick="saveData()" class="btn btn-save">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button></div>
        </div>

        <div class="search-panel no-print">
            <div style="grid-column: span 2;"><label>üîç ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®:</label><input type="text" id="searchIndi" placeholder="‡¶®‡¶æ‡¶Æ/‡¶∞‡ßã‡¶≤..." onkeyup="updateTable()"></div>
            <div><label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø:</label><select id="searchCls" onchange="updateTable()"><option value="">‡¶∏‡¶¨ ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</option><option value="One">One</option><option value="Two">Two</option><option value="Three">Three</option><option value="Four">Four</option><option value="Five">Five</option><option value="Six">Six</option><option value="Seven">Seven</option><option value="Eight">Eight</option><option value="Nine">Nine</option><option value="Ten">Ten</option><option value="Eleven">Eleven</option><option value="Twelve">Twelve</option></select></div>
            <div><label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label><select id="searchGroup" onchange="updateTable()"><option value="">‡¶∏‡¶¨ ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</option><option value="General">General</option><option value="Science">Science</option><option value="Commerce">Commerce</option><option value="Humanities">Humanities</option></select></div>
            <div><label>‡¶∏‡ßá‡¶∂‡¶®:</label><input type="text" id="searchSes" placeholder="‡ß®‡ß¶‡ß®‡ß™-‡ß®‡ß´" onkeyup="updateTable()"></div>
            <div><label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="searchSDate" onchange="updateTable()"></div>
            <div><label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="searchEDate" onchange="updateTable()"></div>
            <div style="grid-column: span 3; display: flex; align-items: flex-end;">
                <button onclick="printFullReport()" class="btn" style="background:#5c6bc0; width: 100%; height: 40px; font-size: 15px;">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <table id="feeTable">
            <thead>
                <tr>
                    <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                    <th>‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶∞‡ßã‡¶≤</th>
                    <th>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</th>
                    <th>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</th> <th>‡¶Æ‡¶æ‡¶∏</th>
                    <th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                    <th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</th>
                    <th>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</th>
                    <th class="no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6">‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü:</td>
                    <td id="grandTotal">0</td>
                    <td id="grandDue">0</td>
                    <td class="no-print"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- TAB 2: INCOME & EXPENSE -->
    <div id="accountsTab" class="tab-content">
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card card-income">
                <p>‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</p>
                <h2 id="totalIncomeDisplay">‡ß≥0</h2>
            </div>
            <div class="card card-expense">
                <p>‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                <h2 id="totalExpenseDisplay">‡ß≥0</h2>
            </div>
            <div class="card card-balance">
                <p>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                <h2 id="totalBalanceDisplay">‡ß≥0</h2>
            </div>
        </div>

        <!-- Add Income/Expense Form -->
        <div class="ie-form no-print">
            <div><label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="ieDate"></div>
            <div><label>‡¶ß‡¶∞‡¶®:</label><select id="ieType" onchange="updateIECategory()">
                <option value="Income">‡¶Ü‡ßü (Income)</option>
                <option value="Expense">‡¶ñ‡¶∞‡¶ö (Expense)</option>
            </select></div>
            <div><label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø:</label><select id="ieCategory">
                <option value="‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü (‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º)">‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü (‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º)</option>
                <option value="‡¶¶‡¶æ‡¶®/‡¶Ö‡¶®‡ßÅ‡¶¶‡¶æ‡¶®">‡¶¶‡¶æ‡¶®/‡¶Ö‡¶®‡ßÅ‡¶¶‡¶æ‡¶®</option>
                <option value="‡¶¨‡ßá‡¶§‡¶®">‡¶¨‡ßá‡¶§‡¶®</option>
                <option value="‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶¨‡¶ø‡¶≤">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶¨‡¶ø‡¶≤</option>
                <option value="‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ñ‡¶∞‡¶ö">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ñ‡¶∞‡¶ö</option>
                <option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
            </select></div>
            <div><label>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label><input type="number" id="ieAmount" placeholder="0"></div>
            <div><label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</label><input type="text" id="ieDesc" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
                 <button onclick="saveIEData()" class="btn" style="background:#2e7d32; margin-top:10px;">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- Search IE -->
        <div class="search-panel no-print" style="grid-template-columns: repeat(3, 1fr);">
             <div><label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="ieSearchSDate" onchange="updateIETable()"></div>
             <div><label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="ieSearchEDate" onchange="updateIETable()"></div>
             <div><label>‡¶ß‡¶∞‡¶®:</label><select id="ieSearchType" onchange="updateIETable()">
                 <option value="">‡¶∏‡¶¨</option>
                 <option value="Income">‡¶Ü‡ßü</option>
                 <option value="Expense">‡¶ñ‡¶∞‡¶ö</option>
             </select></div>
        </div>

        <table id="ieTable">
            <thead>
                <tr>
                    <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                    <th>‡¶ß‡¶∞‡¶®</th>
                    <th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</th>
                    <th>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                    <th>‡¶ü‡¶æ‡¶ï‡¶æ</th>
                    <th class="no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                </tr>
            </thead>
            <tbody id="ieTableBody"></tbody>
        </table>
    </div>

</div>

<script>
    // --- DB KEYS ---
    const DB_NAME = 'universalDB_v12';
    const STUDENT_DB = 'studentListDB_v2';
    const IE_DB = 'incomeExpenseDB_v1'; 
    
    let finalMonthsList = [];
    let tempLogoBase64 = "";
    let students = []; 
    let currentEditId = null; 
    let editingStudentIndex = null; 

    window.onload = function() {
        loadStudentList(); 
        let config = JSON.parse(localStorage.getItem('appConfig'));
        if (!config) {
            config = { name: "‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ", addr: "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ", mob: "‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤", pass: "1234", logo: "" };
            localStorage.setItem('appConfig', JSON.stringify(config));
        }
        loadSettings();
        updateTable();
        updateIETable(); 
        calculateTotals(); 
        updateIECategory(); 
    };

    // --- Helper: Date Format ---
    function formatDate(dateStr) {
        if (!dateStr) return "";
        const parts = dateStr.split('-');
        if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
        return dateStr;
    }

    // --- Tab Switching ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(tabId === 'feeTab') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        else document.querySelectorAll('.tab-btn')[1].classList.add('active');
        
        if(tabId === 'accountsTab') {
            updateIETable();
            calculateTotals();
        }
    }

    // --- Student Management (Settings) ---
    function loadStudentList() {
        let storedStudents = localStorage.getItem(STUDENT_DB);
        if (storedStudents) students = JSON.parse(storedStudents);
        else {
            students = [
                { roll: 101, class: "One", name: "‡¶∞‡¶π‡¶ø‡¶Æ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", section: "A", group: "General", session: "‡ß®‡ß¶‡ß®‡ß™" },
                { roll: 102, class: "One", name: "‡¶∏‡¶æ‡¶¨‡ßç‡¶¨‡¶ø‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®", section: "B", group: "General", session: "‡ß®‡ß¶‡ß®‡ß™" },
                { roll: 101, class: "Ten", name: "‡¶ï‡¶∞‡¶ø‡¶Æ ‡¶â‡¶≤‡ßç‡¶≤‡¶æ‡¶π", section: "A", group: "Science", session: "‡ß®‡ß¶‡ß®‡ß™" }
            ];
            saveStudentList();
        }
        renderStudentPreview();
    }
    function saveStudentList() { localStorage.setItem(STUDENT_DB, JSON.stringify(students)); }
    function renderStudentPreview() {
        const tbody = document.getElementById('studentListPreviewBody');
        if (!tbody) return;
        tbody.innerHTML = "";
        students.forEach((s, index) => {
            tbody.innerHTML += `<tr>
                <td>${s.name}</td><td>${s.class}</td><td>${s.roll}</td><td>${s.section || 'N/A'}</td>
                <td>${s.group || 'N/A'}</td><td>${s.session || 'N/A'}</td>
                <td>
                    <button onclick="editStudentEntry(${index})" style="cursor:pointer; border:none; background:none; color:blue; font-size:16px;">‚úé</button>
                    <button onclick="deleteStudentEntry(${index})" style="cursor:pointer; border:none; background:none; color:red; font-size:16px;">‚úï</button>
                </td>
            </tr>`;
        });
    }
    function saveStudentData() {
        const name = document.getElementById('newStName').value.trim();
        const cls = document.getElementById('newStClass').value.trim();
        const roll = document.getElementById('newStRoll').value.trim();
        const section = document.getElementById('newStSection').value.trim() || "N/A";
        const group = document.getElementById('newStGroup').value.trim() || "General";
        const session = document.getElementById('newStSession').value.trim() || "N/A";
        if (!name || !cls || !roll) { alert("‡¶®‡¶æ‡¶Æ, ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶ì ‡¶∞‡ßã‡¶≤ ‡¶¶‡¶ø‡¶®‡•§"); return; }

        if (editingStudentIndex !== null) {
            students[editingStudentIndex] = { name, class: cls, roll: parseInt(roll), section, group, session };
            editingStudentIndex = null;
            document.getElementById('addStudentBtn').innerText = "‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®";
            document.getElementById('studentFormBox').classList.remove('edit-mode');
        } else {
            const exists = students.find(s => s.class === cls && s.roll == roll);
            if (exists) { alert("‡¶è‡¶á ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶ì ‡¶∞‡ßã‡¶≤‡ßá ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶Ü‡¶õ‡ßá‡¶®‡•§"); return; }
            students.push({ name, class: cls, roll: parseInt(roll), section, group, session });
        }
        saveStudentList();
        renderStudentPreview();
        clearStudentForm();
    }
    function clearStudentForm() {
        document.getElementById('newStName').value = ''; document.getElementById('newStClass').value = '';
        document.getElementById('newStRoll').value = ''; document.getElementById('newStSection').value = '';
        document.getElementById('newStGroup').value = ''; document.getElementById('newStSession').value = '';
    }
    function editStudentEntry(index) {
        const s = students[index];
        document.getElementById('newStName').value = s.name; document.getElementById('newStClass').value = s.class;
        document.getElementById('newStRoll').value = s.roll; document.getElementById('newStSection').value = s.section;
        document.getElementById('newStGroup').value = s.group; document.getElementById('newStSession').value = s.session;
        editingStudentIndex = index;
        document.getElementById('addStudentBtn').innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
        document.getElementById('studentFormBox').classList.add('edit-mode');
    }
    function deleteStudentEntry(index) {
        if(confirm("‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) {
            students.splice(index, 1); saveStudentList(); renderStudentPreview();
        }
    }
    function uploadStudentCSV() {
        const fileInput = document.getElementById('csvStudentFile');
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            let count = 0;
            for (let i = 1; i < lines.length; i++) {
                const p = lines[i].split(',');
                if (p.length >= 3 && p[0].trim() && p[1].trim() && p[2].trim()) {
                    if (!students.find(s => s.class === p[1].trim() && s.roll == p[2].trim())) {
                        students.push({ name: p[0].trim(), class: p[1].trim(), roll: parseInt(p[2].trim()), section: p[3]?p[3].trim():"N/A", group: p[4]?p[4].trim():"General", session: p[5]?p[5].trim():"N/A" });
                        count++;
                    }
                }
            }
            saveStudentList(); renderStudentPreview(); alert(`${count} ‡¶ú‡¶® ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá`);
        };
        reader.readAsText(file);
    }

    // --- Core Settings ---
    function loadSettings() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        document.getElementById('headerName').innerText = config.name;
        document.getElementById('headerAddress').innerText = config.addr + " | " + config.mob;
        if(config.logo) { document.getElementById('schoolLogoImg').src = config.logo; document.getElementById('schoolLogoImg').style.display = "block"; }
    }
    function previewLogo(input) {
        if (input.files && input.files[0]) {
            let reader = new FileReader();
            reader.onload = (e) => { tempLogoBase64 = e.target.result; };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function openSettings() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        if(prompt("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:") === config.pass) document.getElementById('settingsArea').style.display = "block";
        else alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°!");
    }
    function saveSettings() {
        const current = JSON.parse(localStorage.getItem('appConfig'));
        const config = {
            name: document.getElementById('setSchoolName').value || current.name,
            addr: document.getElementById('setSchoolAddr').value || current.addr,
            mob: document.getElementById('setSchoolMob').value || current.mob,
            pass: document.getElementById('setNewPass').value || current.pass,
            logo: tempLogoBase64 || current.logo
        };
        localStorage.setItem('appConfig', JSON.stringify(config));
        location.reload();
    }

    // --- Fee Collection Logic ---
    function findStudent() {
        const roll = document.getElementById('rollInput').value;
        const sClass = document.getElementById('classSelect').value;
        const student = students.find(s => s.roll == roll && s.class == sClass);
        const nameDisplay = document.getElementById('studentNameDisplay');
        if (student) {
            nameDisplay.innerText = student.name + " (‡¶∞‡ßã‡¶≤: " + student.roll + ")";
            if(student.section) document.getElementById('sectionSelect').value = student.section;
            if(student.group) document.getElementById('groupSelect').value = student.group;
            if(student.session) document.getElementById('sessionInput').value = student.session;
        } else nameDisplay.innerText = "‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!";
    }
    function addSelectedMonths() {
        let year = document.getElementById('targetYear').value;
        document.querySelectorAll('input[name="months"]:checked').forEach(cb => {
            let entry = cb.value + "-" + year;
            if(!finalMonthsList.includes(entry)) finalMonthsList.push(entry);
            cb.checked = false;
        });
        document.getElementById('addedMonthsDisplay').innerText = finalMonthsList.join(", ");
    }

    // --- SAVE FEE DATA & SYNC TO INCOME ---
    function saveData() {
        let paid = 0;
        let detailsArr = [];
        
        if(document.getElementById('checkM').checked) { let val = parseFloat(document.getElementById('valM').value)||0; paid += val; detailsArr.push("‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï:" + val); }
        if(document.getElementById('checkS').checked) { let val = parseFloat(document.getElementById('valS').value)||0; paid += val; detailsArr.push("‡¶∏‡ßá‡¶∂‡¶®:" + val); }
        if(document.getElementById('checkE').checked) { let val = parseFloat(document.getElementById('valE').value)||0; paid += val; detailsArr.push("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ:" + val); }
        if(document.getElementById('checkO').checked) { let val = parseFloat(document.getElementById('valO').value)||0; paid += val; detailsArr.push("‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø:" + val); }

        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        
        let entryData = {
            id: currentEditId || Date.now(),
            date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
            session: document.getElementById('sessionInput').value,
            student: document.getElementById('studentNameDisplay').innerText,
            class: document.getElementById('classSelect').value,
            roll: document.getElementById('rollInput').value,
            section: document.getElementById('sectionSelect').value,
            group: document.getElementById('groupSelect').value,
            months: finalMonthsList.join(", "),
            paid, 
            due: parseFloat(document.getElementById('valDue').value) || 0,
            details: detailsArr.length > 0 ? detailsArr.join(", ") : "‡¶®‡¶ó‡¶¶ ‡¶ó‡ßç‡¶∞‡¶π‡¶£"
        };

        if (currentEditId) {
            let index = history.findIndex(i => i.id === currentEditId);
            if (index !== -1) history[index] = entryData;
            currentEditId = null;
            document.getElementById('saveBtn').innerText = "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®";
            document.getElementById('saveBtn').style.background = "#2e7d32";
            alert("‡¶´‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        } else {
            history.push(entryData);
            alert("‡¶´‡¶ø ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }

        localStorage.setItem(DB_NAME, JSON.stringify(history));
        
        syncToAccounts(entryData);

        clearForm();
        updateTable();
        calculateTotals(); 
    }

    function syncToAccounts(feeEntry) {
        let ieHistory = JSON.parse(localStorage.getItem(IE_DB)) || [];
        let existingIndex = ieHistory.findIndex(item => item.refId === feeEntry.id);
        let ieEntry = {
            id: existingIndex !== -1 ? ieHistory[existingIndex].id : Date.now(),
            refId: feeEntry.id, 
            date: feeEntry.date,
            type: "Income",
            category: "‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü",
            amount: feeEntry.paid,
            description: `${feeEntry.student} - ${feeEntry.months}`
        };

        if (existingIndex !== -1) {
            ieHistory[existingIndex] = ieEntry; 
        } else {
            ieHistory.push(ieEntry); 
        }
        localStorage.setItem(IE_DB, JSON.stringify(ieHistory));
    }

    function clearForm() {
        document.getElementById('rollInput').value = '';
        document.getElementById('studentNameDisplay').innerText = '‡¶∞‡ßã‡¶≤ ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶¶‡¶ø‡¶®...';
        document.getElementById('valM').value = ''; document.getElementById('checkM').checked = false;
        document.getElementById('valS').value = ''; document.getElementById('checkS').checked = false;
        document.getElementById('valE').value = ''; document.getElementById('checkE').checked = false;
        document.getElementById('valO').value = ''; document.getElementById('checkO').checked = false;
        document.getElementById('valDue').value = '';
        finalMonthsList = [];
        document.getElementById('addedMonthsDisplay').innerText = "‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡¶æ";
    }

    function editItem(id) {
        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let item = history.find(i => i.id === id);
        
        if (item) {
            currentEditId = id;
            document.getElementById('entryDate').value = item.date;
            document.getElementById('sessionInput').value = item.session;
            document.getElementById('classSelect').value = item.class;
            document.getElementById('rollInput').value = item.roll || ''; 
            document.getElementById('studentNameDisplay').innerText = item.student;
            document.getElementById('sectionSelect').value = item.section;
            document.getElementById('groupSelect').value = item.group;
            
            finalMonthsList = item.months.split(', ').filter(m => m.trim() !== '');
            document.getElementById('addedMonthsDisplay').innerText = item.months;
            
            document.getElementById('checkM').checked = false; document.getElementById('valM').value = '';
            document.getElementById('checkS').checked = false; document.getElementById('valS').value = '';
            document.getElementById('checkE').checked = false; document.getElementById('valE').value = '';
            document.getElementById('checkO').checked = false; document.getElementById('valO').value = '';
            
            if(item.details) {
                let parts = item.details.split(', ');
                parts.forEach(p => {
                    if(p.includes("‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï:")) { document.getElementById('checkM').checked = true; document.getElementById('valM').value = p.split(':')[1]; }
                    if(p.includes("‡¶∏‡ßá‡¶∂‡¶®:")) { document.getElementById('checkS').checked = true; document.getElementById('valS').value = p.split(':')[1]; }
                    if(p.includes("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ:")) { document.getElementById('checkE').checked = true; document.getElementById('valE').value = p.split(':')[1]; }
                    if(p.includes("‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø:")) { document.getElementById('checkO').checked = true; document.getElementById('valO').value = p.split(':')[1]; }
                });
            }
            
            document.getElementById('valDue').value = item.due;
            document.getElementById('saveBtn').innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
            document.getElementById('saveBtn').style.background = "#ff9800";
            window.scrollTo(0, 0);
        }
    }

    function deleteItem(id) {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?")) {
            let h = JSON.parse(localStorage.getItem(DB_NAME));
            localStorage.setItem(DB_NAME, JSON.stringify(h.filter(i => i.id !== id)));
            
            let ie = JSON.parse(localStorage.getItem(IE_DB)) || [];
            ie = ie.filter(item => item.refId !== id);
            localStorage.setItem(IE_DB, JSON.stringify(ie));
            
            updateTable();
            calculateTotals();
        }
    }
    
    function updateTable() {
        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let kIndi = document.getElementById('searchIndi').value.toUpperCase();
        let kCls = document.getElementById('searchCls').value;
        let kGrp = document.getElementById('searchGroup').value;
        let kSes = document.getElementById('searchSes').value;
        let sDate = document.getElementById('searchSDate').value, eDate = document.getElementById('searchEDate').value;

        let tableBody = document.getElementById('tableBody');
        let tPaid = 0, tDue = 0; tableBody.innerHTML = "";

        history.slice().reverse().forEach(item => {
            const matchesSearch = item.student.toUpperCase().includes(kIndi);
            const matchesClass = !kCls || item.class === kCls;
            const matchesGroup = !kGrp || item.group === kGrp;
            const matchesSession = !kSes || (item.session && item.session.includes(kSes));
            const matchesDate = (!sDate || !eDate) || (item.date >= sDate && item.date <= eDate);

            if(matchesSearch && matchesClass && matchesGroup && matchesSession && matchesDate) {
                tPaid += item.paid; tDue += item.due;
                tableBody.innerHTML += `<tr>
                    <td>${formatDate(item.date)}</td>
                    <td>${item.student}</td>
                    <td>${item.class}</td>
                    <td>${item.group}</td> <td>${item.months}</td>
                    <td>${item.details}</td>
                    <td>${item.paid}</td>
                    <td>${item.due}</td>
                    <td class="no-print">
                        <button onclick="editItem(${item.id})" style="background:#ff9800; color:white; border:none; padding:3px 8px; cursor:pointer;">‡¶è‡¶°‡¶ø‡¶ü</button>
                        <button onclick="printReceipt(${item.id})" style="background:#0288d1; color:white; border:none; padding:3px 8px; cursor:pointer;">‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü</button> 
                        <button onclick="deleteItem(${item.id})" style="background:red; color:white; border:none; padding:3px 8px; cursor:pointer;">X</button>
                    </td>
                </tr>`;
            }
        });
        document.getElementById('grandTotal').innerText = tPaid;
        document.getElementById('grandDue').innerText = tDue;
    }

    // --- INCOME EXPENSE LOGIC ---

    function updateIECategory() {
        const type = document.getElementById('ieType').value;
        const catSelect = document.getElementById('ieCategory');
        catSelect.innerHTML = "";
        if (type === 'Income') {
            catSelect.innerHTML = `<option value="‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü (‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º)">‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡ßü (‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º)</option>
                                   <option value="‡¶¶‡¶æ‡¶®/‡¶Ö‡¶®‡ßÅ‡¶¶‡¶æ‡¶®">‡¶¶‡¶æ‡¶®/‡¶Ö‡¶®‡ßÅ‡¶¶‡¶æ‡¶®</option>
                                   <option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ü‡ßü">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶Ü‡ßü</option>`;
        } else {
            catSelect.innerHTML = `<option value="‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶¨‡ßá‡¶§‡¶®">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶¨‡ßá‡¶§‡¶®</option>
                                   <option value="‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶¨‡¶ø‡¶≤">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶¨‡¶ø‡¶≤</option>
                                   <option value="‡¶™‡¶æ‡¶®‡¶ø/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶¨‡¶ø‡¶≤">‡¶™‡¶æ‡¶®‡¶ø/‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶¨‡¶ø‡¶≤</option>
                                   <option value="‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ñ‡¶∞‡¶ö">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶ñ‡¶∞‡¶ö</option>
                                   <option value="‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§">‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§</option>
                                   <option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö</option>`;
        }
    }

    function saveIEData() {
        const date = document.getElementById('ieDate').value || new Date().toISOString().split('T')[0];
        const type = document.getElementById('ieType').value;
        const category = document.getElementById('ieCategory').value;
        const amount = parseFloat(document.getElementById('ieAmount').value) || 0;
        const desc = document.getElementById('ieDesc').value;

        if(amount <= 0) { alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®"); return; }

        let ieHistory = JSON.parse(localStorage.getItem(IE_DB)) || [];
        ieHistory.push({
            id: Date.now(),
            date,
            type,
            category,
            amount,
            description: desc,
            refId: null 
        });

        localStorage.setItem(IE_DB, JSON.stringify(ieHistory));
        document.getElementById('ieAmount').value = "";
        document.getElementById('ieDesc').value = "";
        updateIETable();
        calculateTotals();
    }

    function deleteIEItem(id) {
        if(confirm("‡¶è‡¶á ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?")) {
            let ie = JSON.parse(localStorage.getItem(IE_DB)) || [];
            ie = ie.filter(i => i.id !== id);
            localStorage.setItem(IE_DB, JSON.stringify(ie));
            updateIETable();
            calculateTotals();
        }
    }

    function updateIETable() {
        let ieHistory = JSON.parse(localStorage.getItem(IE_DB)) || [];
        let sDate = document.getElementById('ieSearchSDate').value;
        let eDate = document.getElementById('ieSearchEDate').value;
        let sType = document.getElementById('ieSearchType').value;

        let tbody = document.getElementById('ieTableBody');
        tbody.innerHTML = "";

        ieHistory.slice().reverse().forEach(item => {
            const matchesDate = (!sDate || !eDate) || (item.date >= sDate && item.date <= eDate);
            const matchesType = !sType || item.type === sType;

            if(matchesDate && matchesType) {
                const color = item.type === 'Income' ? 'green' : 'red';
                tbody.innerHTML += `<tr>
                    <td>${formatDate(item.date)}</td>
                    <td style="color:${color}; font-weight:bold">${item.type}</td>
                    <td>${item.category}</td>
                    <td>${item.description}</td>
                    <td style="color:${color}">${item.type === 'Income' ? '+' : '-'} ${item.amount}</td>
                    <td class="no-print">
                        ${!item.refId ? `<button onclick="deleteIEItem(${item.id})" style="background:red; color:white; border:none; padding:3px 8px; cursor:pointer;">X</button>` : '<small>‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</small>'}
                    </td>
                </tr>`;
            }
        });
    }

    function calculateTotals() {
        let ieHistory = JSON.parse(localStorage.getItem(IE_DB)) || [];
        let totalIn = 0, totalEx = 0;
        ieHistory.forEach(item => {
            if(item.type === 'Income') totalIn += item.amount;
            else totalEx += item.amount;
        });
        document.getElementById('totalIncomeDisplay').innerText = "‡ß≥" + totalIn;
        document.getElementById('totalExpenseDisplay').innerText = "‡ß≥" + totalEx;
        document.getElementById('totalBalanceDisplay').innerText = "‡ß≥" + (totalIn - totalEx);
    }

    // --- Print & Backup ---
    
    // REVERTED: Previous Compact Receipt Design
    function printReceipt(id) {
        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let item = history.find(i => i.id === id);
        let config = JSON.parse(localStorage.getItem('appConfig'));
        
        let win = window.open('', '', 'height=750,width=850');
        win.document.write(`
            <html>
            <head>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
                    body { font-family: 'Hind Siliguri', sans-serif; padding: 20px; display: flex; justify-content: center; }
                    .receipt-border { border: 6px double #1a73e8; padding: 30px; width: 620px; background: #fff; box-sizing: border-box; }
                    .h-box { text-align: center; border-bottom: 2px solid #1a73e8; padding-bottom: 12px; margin-bottom: 18px; }
                    .h-box img { width: 75px; height: 75px; margin-bottom: 8px; }
                    .h-box h1 { margin: 0; color: #1a73e8; font-size: 34px; font-weight: 700; }
                    .h-box p { margin: 4px 0; font-size: 16px; color: #333; font-weight: 600; }
                    .title-tag { text-align: center; background: #1a73e8 !important; color: white !important; padding: 10px; font-weight: bold; margin-bottom: 20px; border-radius: 6px; font-size: 22px; -webkit-print-color-adjust: exact; }
                    .info-row { display: flex; justify-content: space-between; border-bottom: 1.5px dotted #999; padding: 12px 0; font-size: 19px; color: #000; }
                    .info-row b { color: #1a73e8; }
                    .details-box { margin-top: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; min-height: 50px; font-size: 18px; background: #fafafa; color: #333; line-height: 1.5; }
                    .amount-section { background: #f0f7ff !important; padding: 20px; border: 2.5px solid #1a73e8; display: flex; justify-content: space-between; -webkit-print-color-adjust: exact; margin-top: 25px; border-radius: 8px; font-size: 24px; }
                    .footer { margin-top: 70px; display: flex; justify-content: space-between; }
                    .sig { width: 190px; border-top: 2px solid #333; text-align: center; font-size: 16px; padding-top: 10px; font-weight: 700; }
                </style>
            </head>
            <body>
                <div class="receipt-border">
                    <div class="h-box">
                        ${config.logo ? `<img src="${config.logo}">` : ''}
                        <h1>${config.name}</h1>
                        <p>${config.addr} | ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${config.mob}</p>
                    </div>
                    <div class="title-tag">‡¶Æ‡¶æ‡¶®‡¶ø ‡¶∞‡¶ø‡¶∏‡¶ø‡¶ü (‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ ‡¶ï‡¶™‡¶ø)</div>
                    <div class="info-row"><span>‡¶®‡¶æ‡¶Æ: <b>${item.student}</b></span><span>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: <b>${formatDate(item.date)}</b></span></div>
                    <div class="info-row"><span>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø: <b>${item.class}</b> | ‡¶∂‡¶æ‡¶ñ‡¶æ: <b>${item.section}</b></span><span>ID: #${item.id.toString().slice(-6)}</span></div>
                    <div class="info-row"><span>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó: <b>${item.group}</b> | ‡¶∏‡ßá‡¶∂‡¶®: <b>${item.session || 'N/A'}</b></span></div>
                    <div class="info-row"><span>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶Æ‡¶æ‡¶∏: <b>${item.months}</b></span></div>
                    <div style="margin-top:15px; font-weight:bold; font-size:18px; color:#555;">‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</div>
                    <div class="details-box">${item.details}</div>
                    <div class="amount-section">
                        <b>‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º: ‡ß≥ ${item.paid}/-</b>
                        <b style="color:#d32f2f">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ‡ß≥ ${item.due}/-</b>
                    </div>
                    <div class="footer">
                        <div class="sig">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï/‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
                        <div class="sig">‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞</div>
                    </div>
                </div>
            </body>
            </html>
        `);
        win.document.close();
        setTimeout(() => { win.print(); win.close(); }, 500);
    }
    
    function printFullReport() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        const tableClone = document.getElementById('feeTable').cloneNode(true);
        tableClone.querySelectorAll('.no-print').forEach(el => el.remove());
        let win = window.open('', '', 'height=800,width=1200');
        win.document.write(`<html><head><style>body{font-family:sans-serif;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;text-align:center;}th{background:#1a73e8;color:white;}</style></head><body>
            <h1 style="text-align:center">${config.name}</h1>
            <h3 style="text-align:center">‡¶´‡¶ø ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
            ${tableClone.outerHTML}
        </body></html>`);
        win.document.close();
        setTimeout(() => { win.print(); win.close(); }, 500);
    }

    function exportData() {
        const data = { 
            config: JSON.parse(localStorage.getItem('appConfig')), 
            history: JSON.parse(localStorage.getItem(DB_NAME)),
            students: JSON.parse(localStorage.getItem(STUDENT_DB)),
            accounts: JSON.parse(localStorage.getItem(IE_DB))
        };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Full_Backup.json'; a.click();
    }

    function importData(input) {
        if (input.files && input.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data = JSON.parse(e.target.result);
                    if(data.config) localStorage.setItem('appConfig', JSON.stringify(data.config));
                    if(data.history) localStorage.setItem(DB_NAME, JSON.stringify(data.history));
                    if(data.students) localStorage.setItem(STUDENT_DB, JSON.stringify(data.students));
                    if(data.accounts) localStorage.setItem(IE_DB, JSON.stringify(data.accounts));
                    alert("‡¶á‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶´‡¶≤!"); location.reload();
                } catch(e) { alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü"); }
            };
            reader.readAsText(input.files[0]);
        }
    }
</script>
</body>
</html>