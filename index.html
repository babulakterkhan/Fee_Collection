<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤ ‡¶´‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü - SMS ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶∂‡¶® ‡¶∏‡¶π</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .school-header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #1a73e8; padding-bottom: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        #schoolLogoImg { max-width: 80px; max-height: 80px; display: none; border-radius: 5px; flex-shrink: 0; }
        .school-info { flex-grow: 1; }
        #headerName { margin: 0; color: #1a73e8; font-size: clamp(20px, 5vw, 30px); white-space: nowrap; }
        #headerAddress { margin: 5px 0 0; font-size: 14px; }
        .settings-panel { display: none; background: #fffde7; border: 1px dashed #fbc02d; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .input-box, .search-panel { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .search-panel { background: #f1f8e9; border: 1px solid #dcedc8; grid-template-columns: repeat(5, 1fr); }
        .full-row { grid-column: span 4; }
        .year-month-box { background: #fff; padding: 15px; border: 1px solid #bbdefb; border-radius: 8px; margin-top: 10px; }
        .month-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 10px; }
        .month-item { font-size: 13px; display: flex; align-items: center; gap: 5px; cursor: pointer; background: #f9f9f9; padding: 5px; border-radius: 4px; border: 1px solid #ddd; }
        .fee-selection { grid-column: span 4; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #1a73e8; color: white; }
        .total-row { background-color: #263238; color: #ffeb3b; font-weight: bold; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-save { background: #2e7d32; width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #studentNameDisplay { font-weight: bold; color: #1565c0; background: #fff; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; min-height: 20px; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="school-header">
        <img id="schoolLogoImg" src="" alt="Logo">
        <div class="school-info">
            <h1 id="headerName">‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...</h1>
            <p id="headerAddress">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</p>
        </div>
        <div style="position: absolute; right: 30px; top: 30px;" class="no-print">
            <button onclick="openSettings()" style="background:#546e7a; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
        </div>
    </div>

    <div id="settingsArea" class="settings-panel no-print">
        <h3>üõ† ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì SMS ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <input type="text" id="setSchoolName" placeholder="‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="text" id="setSchoolAddr" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ">
            <input type="text" id="setSchoolMob" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤)">
            <input type="text" id="setSmsApiKey" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ GreenWeb API Key ‡¶¶‡¶ø‡¶®">
            <input type="text" id="setNewPass" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°">
            <div><label style="font-size:11px;">‡¶≤‡ßã‡¶ó‡ßã ‡¶Ü‡¶™‡¶≤‡ßã‡¶°:</label><input type="file" id="logoUpload" accept="image/*" onchange="previewLogo(this)"></div>
        </div>
        <button onclick="saveSettings()" class="btn" style="background:#2e7d32; margin-top:10px;">‡¶∏‡¶¨ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="document.getElementById('settingsArea').style.display='none'" class="btn" style="background:#757575; margin-top:10px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div class="input-box no-print">
        <div><label>‡¶∞‡ßã‡¶≤:</label><input type="number" id="rollInput" oninput="findStudent()"></div>
        <div><label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø:</label><select id="classSelect" onchange="findStudent()"><option value="One">One</option><option value="Two">Two</option><option value="Three">Three</option><option value="Four">Four</option><option value="Five">Five</option><option value="Six">Six</option><option value="Seven">Seven</option><option value="Eight">Eight</option><option value="Nine">Nine</option><option value="Ten">Ten</option><option value="Eleven">Eleven</option><option value="Twelve">Twelve</option></select></div>
        <div><label>‡¶∂‡¶æ‡¶ñ‡¶æ:</label><select id="sectionSelect"><option value="A">A</option><option value="B">B</option><option value="N/A">N/A</option></select></div>
        <div><label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó:</label><select id="groupSelect"><option value="General">General</option><option value="Science">Science</option><option value="Commerce">Commerce</option><option value="Humanities">Humanities</option></select></div>
        <div style="grid-column: span 2;"><label>‡¶®‡¶æ‡¶Æ:</label><div id="studentNameDisplay">‡¶∞‡ßã‡¶≤ ‡¶ì ‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø ‡¶¶‡¶ø‡¶®...</div></div>
        <div><label>‡¶∏‡ßá‡¶∂‡¶®:</label><input type="text" id="sessionInput" placeholder="‡ß®‡ß¶‡ß®‡ß¨"></div>
        <div><label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" id="entryDate"></div>
        
        <div class="full-row year-month-box">
            <input type="number" id="targetYear" style="width: 100px;" value="2026">
            <button onclick="addSelectedMonths()" class="btn" style="background: #1a73e8; font-size: 12px;">+ ‡¶Æ‡¶æ‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <span id="addedMonthsDisplay" style="font-weight:bold; margin-left:10px; color:red;">‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶®‡¶æ</span>
            <div class="month-grid">
                <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡¶æ‡¶®‡ßÅ"> ‡¶ú‡¶æ‡¶®‡ßÅ</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ"> ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö"> ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤"> ‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Æ‡ßá"> ‡¶Æ‡ßá</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡ßÅ‡¶®"> ‡¶ú‡ßÅ‡¶®</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á"> ‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü"> ‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá"> ‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶Ö‡¶ï‡ßç‡¶ü‡ßã"> ‡¶Ö‡¶ï‡ßç‡¶ü‡ßã</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶®‡¶≠‡ßá"> ‡¶®‡¶≠‡ßá</label>
                <label class="month-item"><input type="checkbox" name="months" value="‡¶°‡¶ø‡¶∏‡ßá"> ‡¶°‡¶ø‡¶∏‡ßá</label>
            </div>
        </div>

        <div class="fee-selection">
            <div>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø<input type="number" id="valM" placeholder="0"><input type="checkbox" id="checkM"></div>
            <div>‡¶∏‡ßá‡¶∂‡¶® ‡¶´‡¶ø<input type="number" id="valS" placeholder="0"><input type="checkbox" id="checkS"></div>
            <div>‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø<input type="number" id="valE" placeholder="0"><input type="checkbox" id="checkE"></div>
            <div>‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø<input type="number" id="valO" placeholder="0"><input type="checkbox" id="checkO"></div>
            <div>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ<input type="number" id="valDue" style="color:red" placeholder="0"></div>
        </div>
        <div class="full-row"><button onclick="saveData()" class="btn btn-save">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì SMS ‡¶™‡¶æ‡¶†‡¶æ‡¶®</button></div>
    </div>

    <table id="feeTable">
        <thead>
            <tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶∞‡ßã‡¶≤</th><th>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡¶ø</th><th>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó</th><th>‡¶Æ‡¶æ‡¶∏</th><th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th><th>‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</th><th>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</th><th class="no-print">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const DB_NAME = 'universalDB_v12';
    let finalMonthsList = [];
    let tempLogoBase64 = "";

    // ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏
    const students = [
        { roll: 101, class: "One", name: "‡¶∞‡¶π‡¶ø‡¶Æ ‡¶Ü‡¶π‡¶Æ‡ßá‡¶¶", mobile: "01715082325" },
        { roll: 102, class: "One", name: "‡¶∏‡¶æ‡¶¨‡ßç‡¶¨‡¶ø‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®", mobile: "01800000000" }
    ];

    window.onload = function() {
        let config = JSON.parse(localStorage.getItem('appConfig'));
        if (!config) {
            config = { name: "‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ", addr: "‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ", mob: "017...", pass: "1234", logo: "", smsKey: "" };
            localStorage.setItem('appConfig', JSON.stringify(config));
        }
        loadSettings();
        updateTable();
    };

    function loadSettings() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        document.getElementById('headerName').innerText = config.name;
        document.getElementById('headerAddress').innerText = config.addr + " | " + config.mob;
        document.getElementById('setSchoolName').value = config.name;
        document.getElementById('setSchoolAddr').value = config.addr;
        document.getElementById('setSchoolMob').value = config.mob;
        document.getElementById('setSmsApiKey').value = config.smsKey || "";
        if(config.logo) {
            document.getElementById('schoolLogoImg').src = config.logo;
            document.getElementById('schoolLogoImg').style.display = "block";
            tempLogoBase64 = config.logo;
        }
    }

    function openSettings() {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        if(prompt("‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:") === config.pass) document.getElementById('settingsArea').style.display = "block";
        else alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°!");
    }

    function saveSettings() {
        const current = JSON.parse(localStorage.getItem('appConfig'));
        const config = {
            name: document.getElementById('setSchoolName').value,
            addr: document.getElementById('setSchoolAddr').value,
            mob: document.getElementById('setSchoolMob').value,
            smsKey: document.getElementById('setSmsApiKey').value,
            pass: document.getElementById('setNewPass').value || current.pass,
            logo: tempLogoBase64
        };
        localStorage.setItem('appConfig', JSON.stringify(config));
        location.reload();
    }

    function findStudent() {
        const roll = document.getElementById('rollInput').value;
        const sClass = document.getElementById('classSelect').value;
        const student = students.find(s => s.roll == roll && s.class == sClass);
        document.getElementById('studentNameDisplay').innerText = student ? student.name : "‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!";
    }

    function addSelectedMonths() {
        let year = document.getElementById('targetYear').value;
        document.querySelectorAll('input[name="months"]:checked').forEach(cb => {
            let entry = cb.value + "-" + year;
            if(!finalMonthsList.includes(entry)) finalMonthsList.push(entry);
            cb.checked = false;
        });
        document.getElementById('addedMonthsDisplay').innerText = finalMonthsList.join(", ");
    }

    // SMS ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (CORS ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶∏‡¶π)
    async function sendSMS(studentName, amount, mobile) {
        const config = JSON.parse(localStorage.getItem('appConfig'));
        if(!config.smsKey || !mobile) {
            console.log("SMS Key or Mobile missing");
            return;
        }

        const msg = `‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ${studentName}-‡¶è‡¶∞ ‡¶´‡¶ø ‡¶¨‡¶æ‡¶¨‡¶¶ ${amount} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ - ${config.name}`;
        
        // CORS Proxy ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        const proxy = "https://api.allorigins.win/get?url=";
        const smsUrl = `https://api.greenweb.com.bd/api.php?json&apikey=${config.smsKey}&to=${mobile}&message=${encodeURIComponent(msg)}`;
        
        try {
            const response = await fetch(proxy + encodeURIComponent(smsUrl));
            const data = await response.json();
            console.log("SMS Response:", data.contents);
        } catch (err) {
            console.error("SMS Error:", err);
        }
    }

    function saveData() {
        let paid = 0;
        let detailsArr = [];
        if(document.getElementById('checkM').checked) { paid += parseFloat(document.getElementById('valM').value)||0; detailsArr.push("‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï"); }
        if(document.getElementById('checkS').checked) { paid += parseFloat(document.getElementById('valS').value)||0; detailsArr.push("‡¶∏‡ßá‡¶∂‡¶®"); }
        if(document.getElementById('checkE').checked) { paid += parseFloat(document.getElementById('valE').value)||0; detailsArr.push("‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ"); }
        if(document.getElementById('checkO').checked) { paid += parseFloat(document.getElementById('valO').value)||0; detailsArr.push("‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø"); }

        const roll = document.getElementById('rollInput').value;
        const sClass = document.getElementById('classSelect').value;
        const studentObj = students.find(s => s.roll == roll && s.class == sClass);

        if(!studentObj) { alert("‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!"); return; }

        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        history.push({
            id: Date.now(),
            date: document.getElementById('entryDate').value || new Date().toISOString().split('T')[0],
            student: studentObj.name + " (‡¶∞‡ßã‡¶≤: " + roll + ")",
            class: sClass,
            group: document.getElementById('groupSelect').value,
            months: finalMonthsList.join(", "),
            paid: paid,
            due: parseFloat(document.getElementById('valDue').value) || 0,
            details: detailsArr.join(", ")
        });

        localStorage.setItem(DB_NAME, JSON.stringify(history));

        // SMS ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞
        if(paid > 0) {
            sendSMS(studentObj.name, paid, studentObj.mobile);
        }

        alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        location.reload();
    }

    function updateTable() {
        let history = JSON.parse(localStorage.getItem(DB_NAME)) || [];
        let tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = "";
        history.reverse().forEach(item => {
            tableBody.innerHTML += `<tr><td>${item.date}</td><td>${item.student}</td><td>${item.class}</td><td>${item.group}</td><td>${item.months}</td><td>${item.details}</td><td>${item.paid}</td><td>${item.due}</td><td><button onclick="deleteItem(${item.id})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button></td></tr>`;
        });
    }

    function deleteItem(id) {
        let h = JSON.parse(localStorage.getItem(DB_NAME));
        localStorage.setItem(DB_NAME, JSON.stringify(h.filter(i => i.id !== id)));
        updateTable();
    }
</script>
</body>
</html>